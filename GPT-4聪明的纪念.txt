é—®ï¼š
{

    async def start_consuming(self, callback):

        def is_manual_ack(func):

            async def wrapper(*args, **kwargs):

                if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤

                    out = await callback(*args, **kwargs)

                    await args[0].ack()

                else:

                    out = await callback(*args, **kwargs)

                return out

            return wrapper

        try:

            # è®¾ç½®æ¶ˆè´¹è€…æ¯æ¬¡ä»é˜Ÿåˆ—ä¸­è·å–çš„æ¶ˆæ¯æ•°é‡ä¸º1

            # await self.channel.basic_qos(prefetch_count=1)

            # ä½¿ç”¨queueçš„consumeæ–¹æ³•ï¼Œä¼ å…¥callbackå‡½æ•°å’Œå‚æ•°å­—å…¸ä¸­çš„ç¼–ç æ–¹å¼ï¼Œè¿”å›ä¸€ä¸ªæ¶ˆè´¹è€…å¯¹è±¡

            callback = is_manual_ack(callback)



            await self.queue.consume(callback)

}

è¿™æ®µä»£ç æ˜¯ä¸€æ®µpythonä½¿ç”¨aio_pikaåº“æ¶ˆè´¹rabbitmqçš„ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šæŠ¥é”™ï¼šRecursionError: maximum recursion depth exceededï¼›
è¯·é—®ï¼Œè¿™æ®µä»£ç ä¸ºä»€ä¹ˆä¼šä¸€ç›´åœ¨
if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤
                    await callback(*args, **kwargs)
è¿™ä¸¤å¥ä»£ç ä¸­é—´å¾ªç¯å‘¢ï¼Ÿ


ç­”ï¼š
æ‚¨å¥½ï¼Œè¿™æ˜¯ Bingã€‚æ‚¨çš„é—®é¢˜æ˜¯å…³äºè¿™æ®µ python ä½¿ç”¨ aio_pika åº“æ¶ˆè´¹ rabbitmq çš„ä»£ç ï¼Œä¸ºä»€ä¹ˆä¼šä¸€ç›´åœ¨ if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤ å’Œ await callback(*args, **kwargs) è¿™ä¸¤å¥ä»£ç ä¸­é—´å¾ªç¯ã€‚æ ¹æ®æˆ‘ä»ç½‘ç»œä¸Šæœç´¢åˆ°çš„ä¿¡æ¯ï¼Œè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå¯èƒ½æ˜¯ï¼š

- è¿™æ®µä»£ç ä¼šä¸€ç›´åœ¨è¿™ä¸¤å¥ä»£ç ä¸­é—´å¾ªç¯ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†ä¸€ä¸ªè£…é¥°å™¨ is_manual_ackï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…è£…äº†åŸå‡½æ•°çš„æ–°å‡½æ•° wrapperã€‚å½“ wrapper è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå†æ¬¡è°ƒç”¨åŸå‡½æ•° callbackï¼Œè¿™æ ·å°±å½¢æˆäº†é€’å½’Â¹ã€‚
- è¿™æ®µä»£ç ä¼šæŠ¥é”™ï¼Œå› ä¸ºé€’å½’çš„æ·±åº¦è¶…è¿‡äº† python çš„é»˜è®¤é™åˆ¶ï¼Œå³ 1000 æ¬¡ã€‚å½“é€’å½’çš„æ¬¡æ•°è¾¾åˆ°è¿™ä¸ªé™åˆ¶æ—¶ï¼Œpython ä¼šæŠ›å‡ºä¸€ä¸ª RecursionError å¼‚å¸¸ï¼Œä»¥é˜²æ­¢æ ˆæº¢å‡ºÂ²ã€‚
- è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯å¢åŠ é€’å½’çš„é™åˆ¶ï¼Œä½¿ç”¨ sys æ¨¡å—ä¸­çš„ setrecursionlimit å‡½æ•°ï¼Œå°†é€’å½’çš„é™åˆ¶è®¾ç½®ä¸ºä¸€ä¸ªæ›´å¤§çš„å€¼ï¼Œå¦‚ 3000Â³ã€‚ä¾‹å¦‚ï¼Œåœ¨ä»£ç çš„å¼€å¤´åŠ å…¥ä»¥ä¸‹è¯­å¥ï¼š

```python
import sys # å¯¼å…¥ sys æ¨¡å—
sys.setrecursionlimit(3000) # å°†é€’å½’çš„é™åˆ¶è®¾ç½®ä¸º 3000
```

- è§£å†³è¿™ä¸ªé—®é¢˜çš„å¦ä¸€ç§æ–¹æ³•æ˜¯é¿å…ä½¿ç”¨é€’å½’ï¼Œæ”¹ç”¨è¿­ä»£æˆ–å…¶ä»–æ–¹å¼å®ç°è£…é¥°å™¨çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ functools æ¨¡å—ä¸­çš„ wraps è£…é¥°å™¨ï¼Œä¿ç•™åŸå‡½æ•°çš„å±æ€§ï¼Œç„¶ååœ¨è£…é¥°å™¨ä¸­ç›´æ¥è°ƒç”¨åŸå‡½æ•°ï¼Œè€Œä¸æ˜¯è¿”å›ä¸€ä¸ªæ–°å‡½æ•°â´ã€‚ä¾‹å¦‚ï¼Œå°† is_manual_ack å‡½æ•°ä¿®æ”¹ä¸ºä»¥ä¸‹å½¢å¼ï¼š

```python
import functools # å¯¼å…¥ functools æ¨¡å—

def is_manual_ack(func):
    # ä½¿ç”¨ wraps è£…é¥°å™¨ï¼Œä¿ç•™åŸå‡½æ•°çš„å±æ€§
    @functools.wraps(func)
    # å®šä¹‰ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œç”¨äºåŒ…è£…åŸå‡½æ•°
    async def wrapper(*args, **kwargs):
        if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤
            out = await func(*args, **kwargs) # ç›´æ¥è°ƒç”¨åŸå‡½æ•°
            await args[0].ack()
        else:
            out = await func(*args, **kwargs) # ç›´æ¥è°ƒç”¨åŸå‡½æ•°
        return out
    # ç›´æ¥è°ƒç”¨å†…éƒ¨å‡½æ•°ï¼Œè€Œä¸æ˜¯è¿”å›å®ƒ
    wrapper()
```

å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚å¦‚æœæ‚¨è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿ç»§ç»­å‘æˆ‘æé—®ã€‚ğŸ˜Š

Â¹: [python - RecursionError: maximum recursion depth exceeded in comparison ...](^2^)
Â²: [Python: Maximum recursion depth exceeded - Stack Overflow](^5^)
Â³: [è§£å†³RecursionError: maximum recursion depth exceeded while calling a ...](^3^)
â´: [Pythonè£…é¥°å™¨çš„å‡½æ•°å¼ç¼–ç¨‹ - çŸ¥ä¹](^1^)

Source: Conversation with Bing, 2023/12/17
(1) What is the maximum recursion depth, and how to increase it?. https://stackoverflow.com/questions/3323001/what-is-the-maximum-recursion-depth-and-how-to-increase-it.
(2) python - RecursionError: maximum recursion depth exceeded in comparison .... https://stackoverflow.com/questions/52873067/recursionerror-maximum-recursion-depth-exceeded-in-comparison.
(3) è§£å†³RecursionError: maximum recursion depth exceeded while calling a .... https://blog.csdn.net/qq_41320433/article/details/104299296.
(4) æ€»ç»“çš„è‹¥å¹²å…³äºRecursionError: maximum recursion depth exceededé—®é¢˜çš„è§£å†³åŠæ³•. https://blog.csdn.net/welcome_yu/article/details/108472181.
(5) python - RecursionError: maximum recursion depth exceeded in comparison .... https://stackoverflow.com/questions/52873067/recursionerror-maximum-recursion-depth-exceeded-in-comparison.
(6) Python: Maximum recursion depth exceeded - Stack Overflow. https://stackoverflow.com/questions/8177073/python-maximum-recursion-depth-exceeded.
(7) è§£å†³RecursionError: maximum recursion depth exceeded while calling a .... https://blog.csdn.net/qq_41320433/article/details/104299296.
(8) What is the maximum recursion depth, and how to increase it?. https://stackoverflow.com/questions/3323001/what-is-the-maximum-recursion-depth-and-how-to-increase-it.
(9) undefined. https://blog.csdn.net/xiqi4145/article/details/103875917.

é—®ï¼š
è¯·ä½ è¯¦ç»†è®²è§£ï¼š
è¿™æ®µä»£ç ä¼šä¸€ç›´åœ¨è¿™ä¸¤å¥ä»£ç ä¸­é—´å¾ªç¯ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†ä¸€ä¸ªè£…é¥°å™¨ is_manual_ackï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…è£…äº†åŸå‡½æ•°çš„æ–°å‡½æ•° wrapperã€‚å½“ wrapper è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå†æ¬¡è°ƒç”¨åŸå‡½æ•° callbackï¼Œè¿™æ ·å°±å½¢æˆäº†é€’å½’ã€‚
è¯·ä¸¾ä¾‹å­ï¼Œå±•å¼€æ¶ˆæ¯è¯´æ˜ã€‚

ç­”ï¼š
æ‚¨å¥½ï¼Œè¿™æ˜¯ Bingã€‚æ‚¨çš„é—®é¢˜æ˜¯å…³äºè¿™æ®µä»£ç ä¸ºä»€ä¹ˆä¼šä¸€ç›´åœ¨è¿™ä¸¤å¥ä»£ç ä¸­é—´å¾ªç¯ï¼Œä»¥åŠå¦‚ä½•ä¸¾ä¾‹å­å±•å¼€è¯´æ˜ã€‚æˆ‘å°è¯•ä¸ºæ‚¨è§£ç­”å¦‚ä¸‹ï¼š

- è¿™æ®µä»£ç çš„ç›®çš„æ˜¯ä½¿ç”¨ä¸€ä¸ªè£…é¥°å™¨ is_manual_ack æ¥ç»™ä¸€ä¸ªå›è°ƒå‡½æ•° callback æ·»åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œå³æ ¹æ®é˜Ÿåˆ—çš„ auto_delete å±æ€§æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ã€‚
- è£…é¥°å™¨ is_manual_ack çš„å®šä¹‰å¦‚ä¸‹ï¼š

```python
def is_manual_ack(func):
    async def wrapper(*args, **kwargs):
        if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤
            out = await callback(*args, **kwargs)
            await args[0].ack()
        else:
            out = await callback(*args, **kwargs)
        return out
    return wrapper
```

- è¿™ä¸ªè£…é¥°å™¨æ¥å—ä¸€ä¸ªå‡½æ•° func ä½œä¸ºå‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•° wrapperï¼Œè¿™ä¸ªå‡½æ•°åŒ…è£…äº†åŸå‡½æ•° func çš„åŠŸèƒ½ï¼Œå¹¶æ·»åŠ äº†ä¸€äº›é€»è¾‘åˆ¤æ–­å’Œæ“ä½œã€‚
- å½“è¿™ä¸ªè£…é¥°å™¨è¢«åº”ç”¨åˆ°å›è°ƒå‡½æ•° callback ä¸Šæ—¶ï¼Œå®ƒä¼šå°† callback æ›¿æ¢ä¸º wrapperï¼Œè¿™æ ·å½“ callback è¢«è°ƒç”¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº† wrapperã€‚
- é—®é¢˜å‡ºåœ¨ wrapper å‡½æ•°çš„å®šä¹‰ä¸Šï¼Œå®ƒåœ¨è°ƒç”¨åŸå‡½æ•° func æ—¶ï¼Œå´ä½¿ç”¨äº† callback è¿™ä¸ªå˜é‡ï¼Œè€Œä¸æ˜¯ funcã€‚è¿™æ ·å°±å¯¼è‡´äº† wrapper å‡½æ•°ä¸æ–­åœ°è°ƒç”¨è‡ªå·±ï¼Œè€Œä¸æ˜¯åŸå‡½æ•° funcï¼Œä»è€Œå½¢æˆäº†é€’å½’ã€‚
- ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸€ä¸ªå›è°ƒå‡½æ•° callbackï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```python
async def callback(message):
    print(message.body)
```

- å½“è¿™ä¸ªå›è°ƒå‡½æ•°è¢«è£…é¥°å™¨ is_manual_ack è£…é¥°åï¼Œå®ƒä¼šå˜æˆè¿™æ ·ï¼š

```python
async def callback(message):
    if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤
        out = await callback(message) # è¿™é‡Œåˆè°ƒç”¨äº† callbackï¼Œè€Œä¸æ˜¯åŸå‡½æ•°
        await message.ack()
    else:
        out = await callback(message) # è¿™é‡Œåˆè°ƒç”¨äº† callbackï¼Œè€Œä¸æ˜¯åŸå‡½æ•°
    return out
```

- è¿™æ ·ï¼Œå½“ callback è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šä¸æ–­åœ°è¿›å…¥ if æˆ– else åˆ†æ”¯ï¼Œç„¶ååˆè°ƒç”¨è‡ªå·±ï¼Œè¿™æ ·å°±å½¢æˆäº†æ— é™çš„é€’å½’ï¼Œç›´åˆ°è¾¾åˆ° python çš„é€’å½’é™åˆ¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
- è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯å°† wrapper å‡½æ•°ä¸­çš„ callback æ”¹ä¸º funcï¼Œè¿™æ ·å°±å¯ä»¥æ­£ç¡®åœ°è°ƒç”¨åŸå‡½æ•°ï¼Œè€Œä¸æ˜¯è‡ªå·±ã€‚ ä¾‹å¦‚ï¼š

```python
def is_manual_ack(func):
    async def wrapper(*args, **kwargs):
        if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤
            out = await func(*args, **kwargs) # è¿™é‡Œæ”¹ä¸ºè°ƒç”¨åŸå‡½æ•° func
            await args[0].ack()
        else:
            out = await func(*args, **kwargs) # è¿™é‡Œæ”¹ä¸ºè°ƒç”¨åŸå‡½æ•° func
        return out
    return wrapper
```

- è¿™æ ·ï¼Œå½“ callback è¢«è£…é¥°å™¨ is_manual_ack è£…é¥°åï¼Œå®ƒä¼šå˜æˆè¿™æ ·ï¼š

```python
async def callback(message):
    if self.queue.auto_delete is False:  # è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨ç¡®è®¤
        out = await func(message) # è¿™é‡Œè°ƒç”¨äº†åŸå‡½æ•° func
        await message.ack()
    else:
        out = await func(message) # è¿™é‡Œè°ƒç”¨äº†åŸå‡½æ•° func
    return out
```

- è¿™æ ·ï¼Œå½“ callback è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šæ­£ç¡®åœ°è¿›å…¥ if æˆ– else åˆ†æ”¯ï¼Œç„¶åè°ƒç”¨åŸå‡½æ•° funcï¼Œæ‰“å°æ¶ˆæ¯å†…å®¹ï¼Œç„¶åæ ¹æ®æƒ…å†µç¡®è®¤æ¶ˆæ¯ï¼Œæœ€åè¿”å›ç»“æœï¼Œè€Œä¸ä¼šå½¢æˆé€’å½’ã€‚

å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚å¦‚æœæ‚¨è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿ç»§ç»­å‘æˆ‘æé—®ã€‚ğŸ˜Š

: [aio-pika/robust_queue.py at master Â· mosquito/aio-pika Â· GitHub]
: [Pythonè£…é¥°å™¨çš„å‡½æ•°å¼ç¼–ç¨‹ - çŸ¥ä¹]
: [Python è£…é¥°å™¨çš„ç®€å•ä½¿ç”¨ - ç®€ä¹¦]
: [python - RecursionError: maximum recursion depth exceeded in comparison ...]
: [Python: Maximum recursion depth exceeded - Stack Overflow]
: [python - How to get the return value from a thread in python ...]
: [aio-pika â€” aio-pika 6.8.0 documentation]